<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drei Herzen - Confeitaria & Sabores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Lato', sans-serif; background-color: #FDFBF5; color: #3d3d3d; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .tab-active { border-bottom-color: #4A5C5A; color: #4A5C5A; font-weight: 700; }
        .card-product { border: 1px solid #EAE3D8; transition: box-shadow 0.3s ease-in-out; }
        .btn-primary { background-color: #728A87; color: white; }
        .quantity-control button { width: 32px; height: 32px; border: 1px solid #ddd; border-radius: 50%; background-color: white; }
        .quantity-control input { width: 40px; font-size: 1.1rem; border: none; background-color: transparent; text-align: center; font-weight: 700; color: #333; }
        .image-overlay-container { position: relative; cursor: pointer; }
        .image-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; }
        .image-overlay-container:hover .image-overlay { opacity: 1; }
        .toast { opacity: 0; transform: translateY(20px); transition: all 0.3s ease-in-out; visibility: hidden; }
        .toast-visible { opacity: 1; transform: translateY(0); visibility: visible; }
        .btn-whatsapp { background-color: #25D366; }
        .status-step { flex: 1; text-align: center; }
        .status-dot { width: 20px; height: 20px; border-radius: 50%; margin: 0 auto 5px; background-color: #e5e7eb; border: 2px solid #d1d5db; }
        .status-line { flex-grow: 1; height: 2px; background-color: #e5e7eb; }
        .status-step.active .status-dot { background-color: #f59e0b; border-color: #d97706; }
        .status-step.completed .status-dot { background-color: #10b981; border-color: #059669; }
        .status-step.completed .status-line { background-color: #10b981; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body>

    <!-- P√ÅGINA INICIAL (/home) -->
    <div id="home-page">
        <header class="text-center pt-12 pb-8">
            <img src="https://imgur.com/1BD4WZD.jpeg" alt="Logotipo da Drei Herzen" class="w-60 mx-auto">
        </header>

        <main class="container mx-auto px-6 max-w-4xl text-center">
            <h2 class="font-serif text-3xl md:text-4xl text-stone-800">Tradi√ß√£o e Sabor que V√™m do Cora√ß√£o</h2>
            <p class="mt-4 text-stone-600 max-w-2xl mx-auto">
                A nossa paix√£o √© criar momentos deliciosos para si e para a sua fam√≠lia, mantendo vivas as receitas que atravessaram gera√ß√µes.
            </p>
            <div class="mt-10">
                <button id="go-to-pedido-btn" class="w-full sm:w-auto bg-green-800/90 text-white font-bold py-3 px-8 rounded-lg text-lg hover:bg-green-800 transition shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i class="fas fa-utensils mr-2"></i> Ver Card√°pio e Fazer Pedido
                </button>
            </div>

            <section class="mt-20 text-left">
                <h3 class="font-serif text-2xl text-stone-800 text-center mb-8">Nossos Destaques</h3>
                <div id="featured-products" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Produtos em destaque ser√£o carregados aqui -->
                </div>
            </section>
            
            <section class="mt-20 py-12 bg-stone-100 rounded-lg">
                 <h3 class="font-serif text-2xl text-stone-800 text-center mb-8">Como Funciona</h3>
                 <div class="flex flex-col md:flex-row justify-center items-center gap-8 md:gap-16">
                    <div class="flex flex-col items-center max-w-xs">
                        <div class="bg-amber-800 text-white rounded-full h-16 w-16 flex items-center justify-center text-2xl font-serif">1</div>
                        <h4 class="font-bold mt-4">Escolha os produtos</h4>
                        <p class="text-sm text-stone-600 mt-1">Navegue pelo nosso card√°pio e adicione os seus itens favoritos ao carrinho.</p>
                    </div>
                    <div class="flex flex-col items-center max-w-xs">
                        <div class="bg-amber-800 text-white rounded-full h-16 w-16 flex items-center justify-center text-2xl font-serif">2</div>
                        <h4 class="font-bold mt-4">Preencha os seus dados</h4>
                        <p class="text-sm text-stone-600 mt-1">Quando terminar, finalize o pedido, preencha os seus dados e envie para o nosso WhatsApp.</p>
                    </div>
                     <div class="flex flex-col items-center max-w-xs">
                        <div class="bg-amber-800 text-white rounded-full h-16 w-16 flex items-center justify-center text-2xl font-serif">3</div>
                        <h4 class="font-bold mt-4">Acompanhe o seu pedido</h4>
                        <p class="text-sm text-stone-600 mt-1">Use o n√∫mero do seu pedido para ver o status em tempo real, desde a prepara√ß√£o at√© √† entrega.</p>
                    </div>
                 </div>
            </section>
            
            <button id="track-order-btn-home" class="mt-12 text-sm text-stone-600 font-semibold border border-stone-300 px-4 py-2 rounded-full hover:bg-stone-100 transition">
                <i class="fas fa-box-open mr-1"></i> J√° tem um pedido? Acompanhe-o aqui
            </button>
        </main>

        <footer class="mt-20 border-t border-stone-200 py-8 text-center text-stone-500 text-sm">
            <p><strong>Drei Herzen Pizzaria</strong></p>
            <p id="footer-horario"></p>
            <div class="mt-4 flex justify-center space-x-4 text-lg">
                <a href="https://www.instagram.com/drei__herzen?igsh=bnRnbHBieDNsYzFz" class="hover:text-stone-800"><i class="fab fa-instagram"></i></a>
                <a href="https://wa.me/47992842032" class="hover:text-stone-800"><i class="fa-brands fa-whatsapp"></i></a>
            </div>
            <p class="mt-4 text-xs">&copy; 2025 Drei Herzen. Todos os direitos reservados.</p>
        </footer>
    </div>

    <div id="pedido-page" class="hidden">
        <header class="text-center pt-8 pb-4 border-b-2 border-stone-200 relative">
            <button id="back-to-home-btn" class="absolute top-4 left-4 text-sm text-stone-600 font-semibold hover:text-stone-800 transition">
                <i class="fas fa-chevron-left mr-1"></i> Voltar para a Home
            </button>
            <img src="https://imgur.com/1BD4WZD.jpeg" alt="Logotipo da Drei Herzen" class="w-48 mx-auto">
        </header>
        <div id="info-loja" class="py-2 text-center text-sm font-semibold border-b border-stone-200"></div>
        <nav class="bg-white shadow-sm sticky top-0 z-10">
            <div id="nav-tabs" class="container mx-auto max-w-3xl flex justify-around"><p class="py-4 text-stone-500">A carregar card√°pio...</p></div>
            <div class="container mx-auto max-w-3xl p-4 border-t border-stone-200">
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-stone-400"></i></span>
                    <input type="text" id="search-bar" placeholder="Pesquisar em todo o card√°pio..." class="w-full pl-10 pr-4 py-2 border rounded-full">
                </div>
            </div>
        </nav>
        <div class="container mx-auto p-4 max-w-3xl pb-32">
            <main id="menu">
                <div id="no-results" class="text-center py-10 text-stone-500 hidden">
                    <i class="fas fa-search fa-2x mb-4"></i><p class="font-semibold">Nenhum produto encontrado</p>
                </div>
            </main>
        </div>
        <footer id="carrinho" class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm shadow-lg p-4 border-t z-10">
            <div class="container mx-auto max-w-3xl flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-lg flex items-center text-stone-700"><i class="fas fa-shopping-bag text-green-800/80 mr-2"></i>Seu Pedido</h2>
                    <h3 id="total" class="font-serif text-xl font-bold text-green-800">R$ 0,00</h3>
                </div>
                <button id="finalizar-pedido" class="bg-green-800/90 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-green-800 transition disabled:bg-gray-400" disabled>Finalizar</button>
            </div>
        </footer>
    </div>
    
    <div id="toast" class="fixed bottom-24 right-4 bg-stone-800 text-white py-2 px-5 rounded-lg shadow-xl z-50 toast">Item adicionado!</div>
    <div id="modal-detalhes" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" onclick="fecharDetalhes()"></div>
    <div id="modal-confirmacao" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40"></div>
    <div id="modal-revisao" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-20"></div>
    <div id="modal-cliente" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30"></div>
    <div id="modal-acompanhar" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50"></div>
    <div id="modal-pedido-confirmado" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, serverTimestamp, query, orderBy, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCEdWqh3-vMqGdwvZ1sN7bJ_W27PRQtheI",
            authDomain: "dreiherzen-c7640.firebaseapp.com",
            projectId: "dreiherzen-c7640",
            storageBucket: "dreiherzen-c7640.appspot.com",
            messagingSenderId: "324520974615",
            appId: "1:324520974615:web:51e4abd4d45add5d9eff52",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const homePage = document.getElementById('home-page');
        const pedidoPage = document.getElementById('pedido-page');
        const goToPedidoBtn = document.getElementById('go-to-pedido-btn');
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        const navTabs = document.getElementById('nav-tabs');
        const menuContainer = document.getElementById('menu');
        const totalFooter = document.getElementById('total');
        const finalizarPedidoBtn = document.getElementById('finalizar-pedido');
        const toastNotification = document.getElementById('toast');
        const searchBar = document.getElementById('search-bar');
        const noResultsMsg = document.getElementById('no-results');
        const modalDetalhes = document.getElementById('modal-detalhes');
        const trackOrderBtnHome = document.getElementById('track-order-btn-home');
        const modalAcompanhar = document.getElementById('modal-acompanhar');
        const modalCliente = document.getElementById('modal-cliente');
        const modalRevisao = document.getElementById('modal-revisao');
        
        window.carrinho = [];
        window.itemParaConfirmar = null;
        window.numeroRestaurante = '';

        function showHomePage() {
            homePage.classList.remove('hidden');
            pedidoPage.classList.add('hidden');
        }
        function showPedidoPage() {
            homePage.classList.add('hidden');
            pedidoPage.classList.remove('hidden');
        }

        goToPedidoBtn.addEventListener('click', showPedidoPage);
        backToHomeBtn.addEventListener('click', showHomePage);

        function openTrackModal() {
            modalAcompanhar.innerHTML = `<div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md"><div class="flex justify-between items-center mb-4"><h2 class="font-serif text-2xl font-bold text-stone-800">Acompanhar Pedido</h2><button id="fechar-acompanhar" class="text-stone-500 hover:text-stone-800 text-2xl">&times;</button></div><form id="form-acompanhar"><label for="order-number-input" class="block text-sm font-medium text-stone-700">Digite o n√∫mero do seu pedido:</label><input type="number" id="order-number-input" required class="mt-1 block w-full border rounded-md p-2"><button type="submit" class="mt-4 w-full bg-green-800/90 text-white font-bold py-2 rounded-lg">Buscar</button></form><div id="status-result" class="mt-6"></div></div>`;
            modalAcompanhar.classList.remove('hidden');
            document.getElementById('fechar-acompanhar').addEventListener('click', () => modalAcompanhar.classList.add('hidden'));
            document.getElementById('form-acompanhar').addEventListener('submit', handleTrackOrderSubmit);
        }
        trackOrderBtnHome.addEventListener('click', openTrackModal);

        async function handleTrackOrderSubmit(e) {
            e.preventDefault();
            const orderNumber = document.getElementById('order-number-input').value;
            if (!orderNumber) return;
            const statusResultDiv = document.getElementById('status-result');
            statusResultDiv.innerHTML = `<p class="text-center">A procurar...</p>`;
            const q = query(collection(db, "pedidos"), where("numeroPedido", "==", orderNumber));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                statusResultDiv.innerHTML = `<p class="text-center text-red-600 font-semibold">Pedido n√£o encontrado.</p>`;
            } else {
                const orderData = querySnapshot.docs[0].data();
                const status = orderData.status;
                const statuses = ['Recebido', 'Em Prepara√ß√£o', 'Pronto', 'Finalizado'];
                const currentIndex = statuses.indexOf(status);
                let statusHtml = '<div class="flex items-center">';
                statuses.forEach((s, index) => {
                    let stepClass = index < currentIndex ? 'completed' : (index === currentIndex ? 'active' : '');
                    statusHtml += `<div class="status-step ${stepClass}"><div class="status-dot"></div><p class="text-xs sm:text-sm">${s}</p></div>`;
                    if (index < statuses.length - 1) statusHtml += `<div class="status-line ${stepClass}"></div>`;
                });
                statusHtml += '</div>';
                statusResultDiv.innerHTML = `<p class="font-semibold mb-4">Status do Pedido #${orderNumber}:</p>${statusHtml}`;
            }
        }

        window.mostrarDetalhes = function(produto) {
            modalDetalhes.innerHTML = `<div class="bg-white rounded-lg shadow-2xl w-full max-w-lg relative" onclick="event.stopPropagation()"><button id="fechar-detalhes-btn" class="absolute -top-3 -right-3 bg-white rounded-full h-8 w-8 text-xl flex items-center justify-center shadow-lg">&times;</button><img src="${produto.img}" alt="Detalhe do produto" class="w-full h-64 object-cover rounded-t-lg"><div class="p-6"><h2 class="font-serif text-3xl text-stone-800">${produto.titulo}</h2><p class="text-stone-600 mt-4">${produto.descricao}</p></div></div>`;
            modalDetalhes.classList.remove('hidden');
            document.getElementById('fechar-detalhes-btn').addEventListener('click', fecharDetalhes);
        }
        window.fecharDetalhes = function() { modalDetalhes.classList.add('hidden'); }
        
        function mostrarToast() {
            toastNotification.classList.add('toast-visible');
            setTimeout(() => toastNotification.classList.remove('toast-visible'), 2000);
        }
        
        window.handleTabClick = function(event) {
            const clickedButton = event.currentTarget;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('tab-active'));
            clickedButton.classList.add('tab-active');
            const targetContentId = `content-${clickedButton.id.split('-')[1]}`;
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('hidden', content.id !== targetContentId);
            });
            searchBar.value = '';
            restaurarVisualizacaoPadrao();
        }
        
        function restaurarVisualizacaoPadrao() {
            const guiaAtivaBtn = document.querySelector('.tab-button.tab-active') || document.querySelector('.tab-button');
            if (guiaAtivaBtn) {
                guiaAtivaBtn.classList.add('tab-active');
                const targetContentId = `content-${guiaAtivaBtn.id.split('-')[1]}`;
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('hidden', content.id !== targetContentId);
                });
            }
            document.querySelectorAll('.card-product').forEach(p => p.style.display = 'block');
            noResultsMsg.classList.add('hidden');
        }
        searchBar.addEventListener('input', () => {
             const termo = searchBar.value.toLowerCase().trim();
            if (termo === "") {
                restaurarVisualizacaoPadrao();
                return;
            }
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('tab-active'));
            let totalResultados = 0;
            document.querySelectorAll('.tab-content').forEach(secao => {
                let resultadosNaSecao = 0;
                secao.querySelectorAll('.card-product').forEach(produto => {
                    const nomeProduto = produto.dataset.name.toLowerCase();
                    const corresponde = nomeProduto.includes(termo);
                    produto.style.display = corresponde ? 'block' : 'none';
                    if (corresponde) {
                        resultadosNaSecao++;
                        totalResultados++;
                    }
                });
                secao.classList.toggle('hidden', resultadosNaSecao === 0);
            });
            noResultsMsg.classList.toggle('hidden', totalResultados > 0);
        });
        
        window.ajustarQuantidade = function(id, delta) {
            const input = document.getElementById(`qtd-input-${id}`);
            let quantidadeAtual = parseInt(input.value) + delta;
            if (quantidadeAtual < 1) quantidadeAtual = 1;
            input.value = quantidadeAtual;
        }

        window.adicionarItem = function(idUnico, nome, preco) {
            const quantidade = parseInt(document.getElementById(`qtd-input-${idUnico}`).value);
            if (window.carrinho.find(item => item.idUnico === idUnico)) {
                window.itemParaConfirmar = { idUnico, nome, preco, quantidade };
                const modalConfirmacao = document.getElementById('modal-confirmacao');
                modalConfirmacao.innerHTML = `<div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm text-center"><h2 class="font-serif text-xl font-bold mb-4 text-stone-800">Item j√° adicionado</h2><p class="text-stone-600 mb-6">Voc√™ j√° tem <strong class="text-stone-800">${nome}</strong> no carrinho. Deseja adicionar mais?</p><div class="flex justify-center gap-4"><button id="cancelar-adicao-btn" class="bg-stone-200 text-stone-800 font-bold py-2 px-6 rounded-lg">Cancelar</button><button id="confirmar-adicao-btn" class="btn-primary font-bold py-2 px-6 rounded-lg">Confirmar</button></div></div>`;
                modalConfirmacao.classList.remove('hidden');
                document.getElementById('confirmar-adicao-btn').onclick = () => {
                    adicionarItemDeFato(window.itemParaConfirmar);
                    window.itemParaConfirmar = null;
                    modalConfirmacao.classList.add('hidden');
                };
                document.getElementById('cancelar-adicao-btn').onclick = () => {
                    window.itemParaConfirmar = null;
                    modalConfirmacao.classList.add('hidden');
                };
            } else {
                adicionarItemDeFato({ idUnico, nome, preco, quantidade });
            }
        }

        function adicionarItemDeFato(item) {
            const itemExistente = window.carrinho.find(i => i.idUnico === item.idUnico);
            if (itemExistente) itemExistente.quantidade += item.quantidade;
            else window.carrinho.push(item);
            document.getElementById(`qtd-input-${item.idUnico}`).value = 1;
            atualizarCarrinho();
            mostrarToast();
        }

        window.removerItem = function(idParaRemover) {
            window.carrinho = window.carrinho.filter(item => item.idUnico !== idParaRemover);
            atualizarCarrinho();
            if (!document.getElementById('modal-revisao').classList.contains('hidden')) mostrarRevisao();
        }

        function calcularTotal() {
            return window.carrinho.reduce((acc, item) => acc + (item.preco * item.quantidade), 0);
        }

        function atualizarCarrinho() {
            const total = calcularTotal();
            totalFooter.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            finalizarPedidoBtn.disabled = total === 0;
        }
        
        function verificarStatusLoja(horarios) {
            const infoLoja = document.getElementById('info-loja');
            const footerHorario = document.getElementById('footer-horario');
            const agora = new Date();
            const diaSemana = agora.getDay();
            const horaAtual = `${String(agora.getHours()).padStart(2, '0')}:${String(agora.getMinutes()).padStart(2, '0')}`;
            const horarioHoje = horarios ? horarios[diaSemana] : null;
            let statusAberto = false;
            if (horarioHoje && horaAtual >= horarioHoje.abre && horaAtual < horarioHoje.fecha) {
                statusAberto = true;
            }
            let statusHtml = statusAberto ? `<span class="bg-green-100 text-green-800 py-1 px-3 rounded-full">Aberto agora</span>` : `<span class="bg-red-100 text-red-800 py-1 px-3 rounded-full">Fechado</span>`;
            let horarioTexto = "Consulte nosso hor√°rio de funcionamento.";
            if(horarios) {
                const diasAbertos = Object.entries(horarios).filter(([, h]) => h !== null);
                if (diasAbertos.length > 0) {
                     const primeiroDia = diasAbertos[0][0];
                     const ultimoDia = diasAbertos[diasAbertos.length - 1][0];
                     const horarioComum = diasAbertos[0][1];
                     const diasDaSemanaTexto = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];
                     horarioTexto = `Hor√°rio: ${diasDaSemanaTexto[primeiroDia]} a ${diasDaSemanaTexto[ultimoDia]}, das ${horarioComum.abre}h √†s ${horarioComum.fecha}h`;
                }
            }
            infoLoja.innerHTML = `${statusHtml} <span class="text-stone-600 ml-2 hidden sm:inline">${horarioTexto}</span>`;
            footerHorario.textContent = horarioTexto;
        }
        
        function mostrarRevisao() {
            if (window.carrinho.length === 0) return;
            modalRevisao.innerHTML = `<div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md"><div class="flex justify-between items-center border-b border-stone-200 pb-3 mb-4"><h2 class="font-serif text-2xl font-bold text-stone-800">Revise seu Pedido</h2><button id="fechar-revisao" class="text-stone-500 hover:text-stone-800 text-2xl">&times;</button></div><div id="lista-revisao" class="space-y-3 max-h-64 overflow-y-auto pr-2"></div><div class="border-t border-stone-200 pt-3 mt-4"><div class="text-sm text-stone-600 p-3 bg-stone-50 rounded-md mb-4 border"><p class="font-semibold text-stone-700"><i class="fas fa-info-circle mr-1"></i> Informa√ß√µes</p><p class="mt-1">A taxa de entrega ser√° informada via WhatsApp. Pode tamb√©m retirar no local.</p></div><div class="flex justify-between font-bold text-xl"><span class="text-stone-800">Total:</span><span id="total-revisao" class="text-green-800 font-serif">R$ 0,00</span></div></div><div class="mt-8"><button id="ir-para-dados" class="w-full bg-green-800/90 text-white font-bold py-3 px-4 rounded-lg text-lg">Continuar</button></div></div>`;
            const listaRevisao = document.getElementById('lista-revisao');
            window.carrinho.forEach(item => {
                listaRevisao.innerHTML += `<div class="flex justify-between items-center text-stone-700"><div><span>${item.quantidade}x </span><span class="font-semibold">${item.nome}</span></div><div class="flex items-center"><span class="font-medium mr-4">R$ ${(item.preco * item.quantidade).toFixed(2).replace('.', ',')}</span><button onclick="removerItem('${item.idUnico}')" class="text-red-500/70 hover:text-red-600 transition"><i class="fas fa-trash-alt"></i></button></div></div>`;
            });
            document.getElementById('total-revisao').textContent = `R$ ${calcularTotal().toFixed(2).replace('.', ',')}`;
            modalRevisao.classList.remove('hidden');
            document.getElementById('fechar-revisao').addEventListener('click', () => modalRevisao.classList.add('hidden'));
            document.getElementById('ir-para-dados').addEventListener('click', () => {
                modalRevisao.classList.add('hidden');
                modalCliente.innerHTML = `<div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md"><h2 class="font-serif text-2xl font-bold mb-4 text-stone-800">Seus Dados</h2><form id="form-cliente"></form></div>`;
                const formCliente = document.getElementById('form-cliente');
                formCliente.innerHTML = `<div class="space-y-4"><div><label for="nome" class="block text-sm font-medium">Nome Completo</label><input type="text" id="nome" required class="mt-1 block w-full border rounded-md p-2"></div><div><label for="telefone" class="block text-sm font-medium">Telefone (WhatsApp)</label><input type="tel" id="telefone" required class="mt-1 block w-full border rounded-md p-2"></div><div><label for="cpf" class="block text-sm font-medium">CPF na nota? (Opcional)</label><input type="text" id="cpf" class="mt-1 block w-full border rounded-md p-2"></div><div class="border-t pt-4 mt-4"><label class="block text-sm font-medium mb-2">Agendar Data e Hora</label><div class="space-y-4"><div><label for="schedule-date" class="block text-sm font-medium">Data</label><input type="date" id="schedule-date" required class="mt-1 block w-full border rounded-md p-2"></div><div><label for="schedule-time" class="block text-sm font-medium">Hora</label><input type="time" id="schedule-time" required class="mt-1 block w-full border rounded-md p-2"></div></div></div><div><label for="observacoes" class="block text-sm font-medium">Observa√ß√µes</label><textarea id="observacoes" rows="3" class="mt-1 block w-full border rounded-md p-2" placeholder="Ex: sem cebola..."></textarea></div></div><div class="mt-8"><button type="submit" class="btn-whatsapp w-full text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center text-lg"><i class="fab fa-whatsapp mr-3"></i>Enviar Pedido</button></div>`;
                document.getElementById('schedule-date').min = new Date().toISOString().split('T')[0];
                modalCliente.classList.remove('hidden');
                formCliente.addEventListener('submit', handleFormSubmit);
            });
        }
        finalizarPedidoBtn.addEventListener('click', mostrarRevisao);
        modalCliente.addEventListener('click', e => { if (e.target === modalCliente) modalCliente.classList.add('hidden'); });
        
        async function handleFormSubmit(e) {
            e.preventDefault();
            const nome = document.getElementById('nome').value.trim();
            const telefone = document.getElementById('telefone').value.trim();
            if(!nome || !telefone) return;
            const cpf = document.getElementById('cpf').value.trim();
            const observacoes = document.getElementById('observacoes').value.trim();
            const scheduleDate = document.getElementById('schedule-date').value;
            const scheduleTime = document.getElementById('schedule-time').value;
            if (!scheduleDate || !scheduleTime) {
                alert("Por favor, selecione data e hora para o agendamento."); return;
            }
            const [year, month, day] = scheduleDate.split('-');
            const formattedDate = `${day}/${month}/${year}`;
            const agendamento = { data: formattedDate, hora: scheduleTime };
            const agendamentoMsg = `\n\n*AGENDADO PARA:*\n- Data: ${formattedDate}\n- Hora: ${scheduleTime}`;

            try {
                const numeroPedido = String(new Date().getTime()).slice(-6);
                const orderData = { numeroPedido, cliente: { nome, telefone, cpf }, itens: window.carrinho, total: calcularTotal(), status: 'Recebido', observacoes, timestamp: serverTimestamp(), agendamento };
                const docRef = await addDoc(collection(db, "pedidos"), orderData);
                
                let msg = `Ol√°! üëã Novo Pedido (#${numeroPedido}) de *Drei Herzen*:\n\n*CLIENTE:*\n- Nome: ${nome}\n- Telefone: ${telefone}\n`;
                if (cpf) msg += `- CPF: ${cpf}\n`;
                if (observacoes) msg += `- Obs: ${observacoes}\n`;
                msg += agendamentoMsg;
                msg += `\n\n*PEDIDO:*\n`;
                window.carrinho.forEach(item => { msg += `- ${item.quantidade}x ${item.nome}\n`; });
                msg += `\n*TOTAL: R$ ${calcularTotal().toFixed(2).replace('.', ',')}*`;
                
                modalCliente.classList.add('hidden');
                const modalConfirmado = document.getElementById('modal-pedido-confirmado');
                modalConfirmado.innerHTML = `<div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm text-center"><i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i><h2 class="font-serif text-2xl font-bold mb-2 text-stone-800">Pedido Recebido!</h2><p class="text-stone-600 mb-4">O seu pedido √© o n√∫mero:</p><p id="confirmed-order-number" class="text-3xl font-bold bg-stone-100 p-2 rounded-md mb-6">${numeroPedido}</p><button id="fechar-confirmacao-pedido" class="w-full bg-stone-700 text-white font-bold py-2 px-6 rounded-lg">Fechar</button></div>`;
                modalConfirmado.classList.remove('hidden');

                document.getElementById('fechar-confirmacao-pedido').onclick = () => {
                    window.location.href = `https://wa.me/${window.numeroRestaurante}?text=${encodeURIComponent(msg)}`;
                    setTimeout(() => {
                        modalConfirmado.classList.add('hidden');
                        document.getElementById('form-cliente').innerHTML = '';
                        window.carrinho = [];
                        atualizarCarrinho();
                    }, 500);
                };

            } catch (error) {
                console.error("Erro ao salvar pedido: ", error);
                alert("N√£o foi poss√≠vel registar o seu pedido. Tente novamente.");
            }
        }
        
        async function loadMenuAndFeatured() {
            const categoriesQuery = query(collection(db, 'categorias'), orderBy('ordem'));
            const productsSnapshot = await getDocs(collection(db, 'produtos'));
            const categoriesSnapshot = await getDocs(categoriesQuery);
            
            const products = [];
            productsSnapshot.forEach(doc => products.push({ id: doc.id, ...doc.data() }));

            renderMenu(categoriesSnapshot, products);
            renderFeaturedProducts(products);
        }

        function renderFeaturedProducts(products) {
            const featuredContainer = document.getElementById('featured-products');
            featuredContainer.innerHTML = '';
            const featured = products.slice(0, 3);
            if (featured.length === 0) {
                 featuredContainer.parentElement.classList.add('hidden');
                 return;
            }
            featured.forEach(product => {
                const price = Number(product.preco).toFixed(2).replace('.',',');
                featuredContainer.innerHTML += `<div class="card-product rounded-lg bg-white overflow-hidden text-center">${product.imagemUrl ? `<img src="${product.imagemUrl}" alt="${product.nome}" class="w-full h-40 object-cover">` : ''}<div class="p-4"><h4 class="font-serif text-lg text-stone-800">${product.nome}</h4><p class="font-bold text-stone-700 mt-1">R$ ${price}</p></div></div>`;
            });
        }

        function renderMenu(categoriesSnapshot, products) {
            navTabs.innerHTML = '';
            menuContainer.innerHTML = '<div id="no-results" class="text-center py-10 text-stone-500 hidden"><i class="fas fa-search fa-2x mb-4"></i><p class="font-semibold">Nenhum produto encontrado</p></div>';
            let isFirstTab = true;
            categoriesSnapshot.forEach(doc => {
                const category = { id: doc.id, ...doc.data() };
                const tabButton = document.createElement('button');
                tabButton.id = `tab-${category.id}`;
                tabButton.className = `tab-button w-full py-4 text-center border-b-2 transition ${isFirstTab ? 'tab-active' : 'border-transparent'}`;
                tabButton.textContent = category.nome;
                navTabs.appendChild(tabButton);
                const section = document.createElement('section');
                section.id = `content-${category.id}`;
                section.className = `tab-content ${isFirstTab ? '' : 'hidden'}`;
                section.innerHTML = `<h2 class="font-serif text-2xl text-stone-700 mb-4 section-title">${category.nome}</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>`;
                menuContainer.appendChild(section);
                const productGrid = section.querySelector('.grid');
                products.filter(p => p.categoriaId === category.id).forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'card-product rounded-lg bg-white overflow-hidden';
                    productCard.dataset.name = product.nome.toLowerCase();
                    let imagemHtml = '';
                    if (product.imagemUrl) {
                        const escapedDescricao = product.descricao.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const escapedNome = product.nome.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        imagemHtml = `<div class="image-overlay-container" onclick="mostrarDetalhes({img: '${product.imagemUrl}', titulo: '${escapedNome}', descricao: '${escapedDescricao}'})"><img src="${product.imagemUrl}" alt="${product.nome}" class="w-full h-48 object-cover"><div class="image-overlay"><i class="fas fa-search-plus fa-2x"></i></div></div>`;
                    }
                    const escapedNomeAdicionar = product.nome.replace(/'/g, "\\'");
                    productCard.innerHTML = `<div class="p-4"><h3 class="font-serif text-xl">${product.nome}</h3><p class="text-lg font-bold mt-2">R$ ${Number(product.preco).toFixed(2).replace('.', ',')}</p><div class="mt-4 flex items-center justify-between bg-stone-50 p-2 rounded-lg border"><div class="quantity-control flex items-center gap-3"><button onclick="ajustarQuantidade('${product.idUnico}', -1)">-</button><input type="number" id="qtd-input-${product.idUnico}" value="1" min="1" class="w-12 text-center bg-transparent font-bold"><button onclick="ajustarQuantidade('${product.idUnico}', 1)">+</button></div><button onclick="adicionarItem('${product.idUnico}', '${escapedNomeAdicionar}', ${product.preco})" class="btn-primary font-bold py-2 px-4 rounded-full">Adicionar</button></div></div>`;
                    if (imagemHtml) productCard.insertAdjacentHTML('afterbegin', imagemHtml);
                    productGrid.appendChild(productCard);
                });
                isFirstTab = false;
            });
            document.querySelectorAll('.tab-button').forEach(button => button.addEventListener('click', window.handleTabClick));
        }
        
        async function loadApp() {
            const configRef = doc(db, 'configuracoes', 'loja');
            const docSnap = await getDoc(configRef);
            let horarios = null;
            if (docSnap.exists()) {
                const config = docSnap.data();
                window.numeroRestaurante = config.telefoneWhatsapp || '5547988341912';
                horarios = config.horarios;
            }
            verificarStatusLoja(horarios);
            await loadMenuAndFeatured();
            atualizarCarrinho();
        }
        
        document.addEventListener('DOMContentLoaded', loadApp);
    </script>
</body>
</html>

